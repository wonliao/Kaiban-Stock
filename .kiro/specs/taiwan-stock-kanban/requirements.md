# 需求規格文件

## 假設條件與待釐清問題

### 假設條件
1. **A001**: TWSE-MCP Server 提供標準化 REST/GraphQL 端點，盤中資料延遲 15-20 分鐘
2. **A002**: 使用者認證採用 JWT 令牌搭配角色權限控制
3. **A003**: 交易時段為台北時間 09:00-13:30，週一至週五（不含假日）
4. **A004**: 每個看板最多 500 張卡片以維持效能
5. **A005**: 技術指標（MA、KD、RSI）可在伺服器端計算，視窗期間可設定
6. **A006**: 稽核軌跡保存期間為 90 天以符合法規要求
7. **A007**: MVP 版本不需要 WebSocket 即時更新，輪詢方式即可
8. **A008**: 系統採用容器化部署（Docker + Kubernetes），支援水平擴展與滾動更新

### 待釐清問題（優先級：H=高，M=中，L=低）
1. **OQ001 (H)**: TWSE-MCP Server 的確切 API 架構、端點規格與速率限制為何？
2. **OQ002 (H)**: TWSE-MCP Server 提供的歷史資料深度與更新頻率為何？
3. **OQ003 (H)**: 技術指標計算應即時處理或批次處理？效能影響評估？
4. **OQ004 (M)**: TWSE 資料顯示的具體法規要求與免責聲明格式為何？
5. **OQ005 (M)**: 系統是否需支援每位使用者多個觀察清單？
6. **OQ006 (M)**: Real-Time Stock Data Visualizer 的授權模式與商業使用限制？
7. **OQ007 (L)**: 是否需要特定通知管道（電子郵件、簡訊、webhook）？
8. **OQ008 (L)**: 備援架構是否需要跨地區部署？成本考量？
9. **OQ009 (L)**: 資料快取層設計細節？Redis 叢集或 CDN 或記憶體快取策略？

## 專案簡介

本文件定義台股看板式追蹤面板的需求規格，讓使用者透過視覺化看板介面追蹤個股在不同投資階段的狀態。系統整合 TWSE-MCP Server 取得市場資料，提供基於規則的自動卡片移動功能，同時支援手動拖拉操作。

## 功能需求

### 需求 1：股票觀察清單管理

**使用者故事：** 身為投資人，我希望能管理台股觀察清單，以便追蹤感興趣的特定證券。

#### 驗收條件

1. 當使用者新增股票代碼時，系統應驗證代碼是否存在於 TWSE 上市清單中
2. 當使用者新增有效股票代碼時，系統應建立新的看板卡片，初始狀態為「觀察」
3. 當使用者從觀察清單移除股票時，系統應封存卡片並保留稽核歷史
4. 若觀察清單超過 500 檔股票，系統應拒絕新增並顯示錯誤訊息
5. 當觀察清單異動時，系統應記錄變更，包含使用者 ID、時間戳記與操作類型

### 需求 2：即時股價資料整合

**使用者故事：** 身為投資人，我希望看到當前股價與技術指標，以便做出明智的投資決策。

#### 驗收條件

1. 當市場開盤時（台北時間 09:00-13:30），系統應每 60 秒取得股票資料
2. 當市場收盤時，系統應每 300 秒取得股票資料
3. 當 TWSE-MCP 回傳資料時，系統應在 5 秒內更新卡片的價格、成交量與計算指標
4. 若 TWSE-MCP 無法使用，系統應顯示最後已知資料並標示過時狀態
5. 當顯示資料時，系統應顯示「資料延遲 15-20 分鐘，來源：TWSE-MCP」免責聲明

### 需求 3：看板視覺化介面

**使用者故事：** 身為投資人，我希望看到股票依投資階段分欄顯示，以便視覺化投資組合狀態。

#### 驗收條件

1. 當使用者存取看板時，系統應顯示欄位：觀察、準備買進、持有、賣出、警示
2. 當使用者檢視卡片時，系統應顯示：股票代碼、名稱、現價、漲跌幅%、成交量、MA20、RSI、最後更新時間，以及互動式迷你圖表顯示近 30 日股價走勢與移動平均線
3. 當使用者點擊卡片圖表時，系統應展開詳細圖表視窗，顯示可調整時間範圍的 K 線圖、技術指標（RSI、KD、MACD）與成交量
4. 當使用者拖拉卡片至不同欄位時，系統應更新卡片狀態並記錄變更
5. 當看板載入時，系統應在 300ms 內完成渲染（不含外部資料取得與圖表繪製）
6. 若看板超過 100 張卡片，系統應實作分頁功能，每頁 50 張卡片
7. 當圖表資料載入時，系統應顯示載入指示器，圖表渲染時間應 <2 秒

### 需求 4：自動規則式卡片移動

**使用者故事：** 身為投資人，我希望股票能根據技術指標自動在欄位間移動，以免錯過重要訊號。

#### 驗收條件

1. 當股票漲幅 ≥3% 且量比 ≥1.5 時，系統應將卡片移至「準備買進」
2. 當股價突破 MA20 時，系統應將卡片移至「準備買進」
3. 當股價跌破 MA20 時，系統應將卡片移至「警示」
4. 當 RSI >70 且卡片在「持有」時，系統應將卡片移至「賣出」
5. 當自動規則觸發時，系統應等待 300 秒後才執行，以防止震盪

### 需求 5：使用者認證與授權

**使用者故事：** 身為系統管理員，我希望控制使用者存取層級，以維護資料安全與適當權限。

#### 驗收條件

1. 當使用者登入時，系統應透過 JWT 令牌認證，Access Token 有效期 1 小時，Refresh Token 有效期 30 天
2. 當 Access Token 過期時，系統應自動使用 Refresh Token 更新，無需重新登入
3. 當使用者具有「檢視者」角色時，系統應允許唯讀存取看板
4. 當使用者具有「編輯者」角色時，系統應允許卡片移動與備註編輯
5. 當使用者具有「管理員」角色時，系統應允許觀察清單管理與使用者管理
6. 當嘗試未授權存取時，系統應回傳 HTTP 403 與錯誤詳情
7. 當資料傳輸時，系統應強制使用 HTTPS/TLS 1.3 加密
8. 當偵測到異常登入行為時，系統應要求額外驗證並記錄安全事件

### 需求 6：搜尋與篩選

**使用者故事：** 身為投資人，我希望能搜尋與篩選股票，以便快速找到特定證券或群組。

#### 驗收條件

1. 當使用者輸入搜尋查詢時，系統應依股票代碼、名稱或備註篩選卡片
2. 當使用者選擇狀態篩選時，系統應僅顯示所選欄位的卡片
3. 當使用者套用排序時，系統應依價格變動、成交量或更新時間排序卡片
4. 當搜尋結果超過 50 筆時，系統應分頁顯示並提供導覽控制項
5. 當無搜尋結果時，系統應顯示「無符合條件的股票」訊息

### 需求 7：稽核軌跡與法規遵循

**使用者故事：** 身為法遵人員，我希望追蹤所有使用者操作，以維護法規遵循並調查問題。

#### 驗收條件

1. 當使用者移動卡片時，系統應記錄：使用者 ID、股票代碼、來源/目標狀態、時間戳記、原因
2. 當使用者修改觀察清單時，系統應記錄：使用者 ID、操作、股票代碼、時間戳記
3. 當查詢稽核日誌時，系統應在 2 秒內回傳結果
4. 當稽核資料超過 90 天時，系統應封存至冷儲存
5. 當顯示 TWSE 資料時，系統應包含延遲免責聲明與資料來源標示

### 需求 8：效能與可靠性

**使用者故事：** 身為使用者，我希望系統在交易時段快速且可靠，以便及時做出投資決策。

#### 驗收條件

1. 當交易時段存取系統時，正常運行時間應 ≥99.5%，MTTR <15 分鐘
2. 當呼叫 API 端點時，p95 回應時間應 <300ms（不含外部 MCP 呼叫）
3. 當 TWSE-MCP 緩慢/無法使用時，系統應提供快取資料並標示過時狀態
4. 當系統承受高負載時，速率限制應在每使用者每分鐘 100 次請求時啟動（基準硬體：4 vCPU / 8 GB RAM）
5. 當發生錯誤時，系統應回傳結構化錯誤，包含代碼、訊息與追蹤 ID
6. 當外部 API 呼叫失敗時，系統應執行指數退避重試機制，最多重試 3 次
7. 當系統偵測到異常時，應在 30 秒內觸發告警並執行自動恢復程序
8. 當主要服務不可用時，系統應切換至備援模式，提供基本唯讀功能

### 需求 9：技術指標計算

**使用者故事：** 身為投資人，我希望看到自動計算的技術指標，以便做出資料驅動的決策。

#### 驗收條件

1. 當股票資料更新時，系統應使用收盤價計算 MA5、MA10、MA20、MA60
2. 當計算 RSI 時，系統應使用 14 日期間與標準公式
3. 當計算 KD 時，系統應使用 9 日期間計算 %K，3 日 SMA 計算 %D
4. 當歷史資料不足時，系統應顯示「計算中...」直到有 20+ 個資料點
5. 當指標計算完成時，系統應在交易時段快取結果 60 秒

### 需求 10：互動式圖表與視覺化

**使用者故事：** 身為投資人，我希望透過互動式圖表分析股票走勢，以便做出更精準的投資判斷。

#### 驗收條件

1. 當卡片顯示迷你圖表時，系統應繪製近 30 日收盤價線圖與 MA20 移動平均線
2. 當使用者點擊展開圖表時，系統應顯示可選擇 1M/3M/6M/1Y 時間範圍的完整圖表
3. 當展開圖表時，系統應提供 K 線圖、RSI（14日）、KD（9,3）、MACD（12,26,9）技術指標
4. 當使用者在圖表上滑鼠懸停時，系統應顯示該日期的 OHLC 價格與指標數值
5. 當圖表資料更新時，系統應平滑動畫過渡，避免閃爍
6. 當圖表載入失敗時，系統應顯示「圖表暫時無法載入」並提供重試按鈕
7. 當使用者縮放或平移圖表時，系統應保持操作流暢度 >30fps
8. 當市場開盤時，圖表應每 60 秒自動更新最新資料點，無需手動重新整理

### 需求 11：國際化與本地化

**使用者故事：** 身為國際使用者，我希望系統支援多語言介面，以便更好地理解與操作系統。

#### 驗收條件

1. 當使用者選擇語言時，系統應支援繁體中文與英文介面切換
2. 當顯示數值時，系統應依使用者地區設定格式化貨幣、日期與數字
3. 當顯示股票名稱時，系統應同時提供中文名稱與英文代碼
4. 當錯誤訊息顯示時，系統應提供對應語言的本地化訊息
5. 當使用者變更語言設定時，系統應即時更新介面而無需重新載入
6. 當系統預設語言時，應依瀏覽器語言設定自動選擇繁中或英文

### 需求 12：通知與警示系統

**使用者故事：** 身為投資人，我希望在重要事件發生時收到通知，以便及時採取行動。

#### 驗收條件

1. 當股票觸發自動規則時，系統應發送瀏覽器推播通知給相關使用者
2. 當使用者設定價格警示時，系統應在達到條件時發送通知
3. 當系統提供 Webhook 端點時，外部系統可訂閱卡片狀態變更事件
4. 當使用者偏好設定時，系統應允許選擇通知類型（推播、電子郵件、Webhook）
5. 當通知發送失敗時，系統應重試 3 次並記錄失敗原因
6. 當使用者離線時，系統應累積通知並在重新連線時批次顯示

### 需求 13：使用者體驗與無障礙設計

**使用者故事：** 身為不同需求的使用者，我希望系統提供良好的使用體驗與無障礙支援。

#### 驗收條件

1. 當使用行動裝置時，系統應提供響應式設計，支援 320px 以上螢幕寬度
2. 當使用鍵盤操作時，系統應支援 Tab 鍵導覽與快捷鍵操作
3. 當使用螢幕閱讀器時，系統應提供適當的 ARIA 標籤與語意化標記
4. 當顯示顏色資訊時，系統應同時提供文字或圖示輔助，符合色盲友善設計
5. 當載入內容時，系統應提供載入狀態指示器與進度回饋
6. 當發生錯誤時，系統應提供清楚的錯誤訊息與建議解決方案

### 需求 14：測試策略與品質保證

**使用者故事：** 身為品質保證人員，我希望系統具備完整的測試覆蓋率，以確保功能正確性與穩定性。

#### 驗收條件

1. 當核心功能開發完成時，單元測試覆蓋率應達 80% 以上（後端使用 JUnit/Mockito，前端使用 Jest/React Testing Library）
2. 當 API 端點實作時，系統應提供整合測試驗證端到端流程（使用 Cypress 或 Playwright 進行 E2E 測試）
3. 當系統部署前，應執行負載測試驗證 1000 併發使用者效能（使用 JMeter 或 K6 測試框架）
4. 當新功能發布時，應執行回歸測試確保既有功能不受影響
5. 當使用者驗收測試時，應涵蓋所有主要使用情境與邊界條件
6. 當自動化測試失敗時，系統應阻止部署並通知開發團隊

### 需求 15：錯誤處理與標準化

**使用者故事：** 身為開發人員，我希望系統具備統一的錯誤處理機制，以便快速診斷與解決問題。

#### 驗收條件

1. 當 API 回傳錯誤時，系統應使用統一格式：`{code, message, traceId, timestamp, hint}`
2. 當 HTTP 狀態碼對應時，系統應遵循標準：400（請求錯誤）、401（未認證）、403（無權限）、404（不存在）、500（伺服器錯誤）
3. 當錯誤發生時，系統應產生唯一追蹤 ID 並記錄完整堆疊資訊
4. 當使用者遇到錯誤時，系統應提供友善的錯誤訊息與可能的解決建議
5. 當系統錯誤時，應自動收集診斷資訊並發送至監控系統
6. 當錯誤頻率異常時，系統應觸發告警並執行自動恢復程序

### 需求 16：資料模型與儲存

**使用者故事：** 身為系統架構師，我希望有穩健的資料模型，以便系統能擴展並維護資料完整性。

#### 驗收條件

1. 當儲存股票資料時，系統應維護觀察清單、卡片與快照間的參照完整性
2. 當新增重複股票代碼時，系統應防止同一使用者觀察清單內的重複項目
3. 當歷史資料超過 1 年時，系統應封存舊記錄以維持效能
4. 當執行資料庫查詢時，(user_id, stock_code, timestamp) 複合索引應確保 <100ms 回應
5. 當系統備份執行時，系統應在 30 分鐘內完成且不影響效能，備份保留期限為 30 天